---

- name: Install nvm
  git:
    repo: "https://github.com/creationix/nvm.git"
    dest: "{{ home }}/.nvm"
    version: "{{ nvm.version }}"
  tags: nvm
  become: true
  become_user: "{{ user_name }}"

- name: Install node and set version
  shell: /bin/bash -c 'source {{ home }}/.nvm/nvm.sh && [ "$(type -t nvm)" == "function" ] && [ "$(nvm current)" == "{{node.version}}" ] && echo "nvm already setup" || nvm install {{node.version}}'
  become: true
  become_user: "{{ user_name }}"

#- name: Create npm global directory
#  file:
#    path: "{{ npm_config_prefix }}"
#    owner: "{{ nodejs_install_npm_user }}"
#    group: "{{ nodejs_install_npm_user }}"
#    state: directory

- name: Ensure npm global packages are installed.
  npm:
    name: "{{ item.name }}"
    global: yes
    state: latest
#  environment:
#    NPM_CONFIG_PREFIX: "{{ npm_config_prefix }}"
#    NODE_PATH: "{{ npm_config_prefix }}/lib/node_modules"
#    NPM_CONFIG_UNSAFE_PERM: "{{ npm_config_unsafe_perm }}"
  with_items: "{{ npm_packages }}"
  executable: "{{ home }}/.nvm/versions/node/{{ node.version }}/bin/node"
  become: false
